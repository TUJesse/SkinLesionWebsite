<!DOCTYPE html>
<html>
<body onload="myMap()">
<h1>Referral System based on location</h1>
<p>Click the button to get your coordinates.</p>

<button onclick="myMap()">Try It</button>


<h1>Google Map Location</h1>

<div id="googleMap" style="width:100%;height:600px;"></div>

<p id="demo"></p>

<div id="list">
{% for hospital in hospitalList %}
    <div style="border-style: outset">{{ hospital }}</div>
{% endfor %}
</div>

<script>
const x = document.getElementById("demo");

function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition);
  } else {
    x.innerHTML = "Geolocation is not supported by this browser.";
  }
}

function showPosition(position) {
  x.innerHTML = "Latitude: " + position.coords.latitude +
  "<br>Longitude: " + position.coords.longitude;
}
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>



<script>
    
   var lat;
   var lon;
   var map;
   let service;
   var myLatlng;
   var lat_lng;
   let infowindow;

    function myMap() {

        if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition);
  } else {
    x.innerHTML = "Geolocation is not supported by this browser.";
  }

    }

    function showPosition(position) {
  lat =  position.coords.latitude;
  lon = position.coords.longitude;

  myLatlng = new google.maps.LatLng(lat,lon);
  lat_lng = {'lat': lat, 'lng': lon};

  var mapProp= {
  center:myLatlng,
  zoom:15,
};

infowindow = new google.maps.InfoWindow();
map = new google.maps.Map(document.getElementById("googleMap"),mapProp);

var request = {
    location: myLatlng,
    radius: '50000',
    type: ['hospital']
  };

{#var marker = new google.maps.Marker({position: myLatlng,#}
{#    title:"Your Location"});#}

service = new google.maps.places.PlacesService(map);
service.nearbySearch(request, callback);

{#marker.setMap(map);#}
}

$.ajax({
    url: 'http://127.0.0.1:8000/referral/',  // URL of your Django view
    type: 'post',  // HTTP method, e.g., 'post'
    data: {
        'data': lat,  // Send the JavaScript variable
        'data2': lon,
        'csrfmiddlewaretoken': '{{ csrf_token }}'  // CSRF token for Django
    },
    success: function(response) {
        // Code to execute if the request succeeds;
        // the response is passed to the function
        console.log('Success:', response);
    },
    error: function(error) {
        // Code to execute if the request fails; the raw request and
        // status codes are passed to the function
        console.log('Error:', error);
    }
         });

function callback(results, status) {
  if (status == google.maps.places.PlacesServiceStatus.OK) {
    for (var i = 0; i < results.length; i++) {
      createMarker(results[i]);
    }
  }
}

function createMarker(place) {
  if (!place.geometry || !place.geometry.location) return;

  const marker = new google.maps.Marker({
    map,
    position: place.geometry.location,
  });

  google.maps.event.addListener(marker, "click", () => {
    infowindow.setContent(place.name || "");
    infowindow.open(map);
  });
}


{% comment %}var mapProp= {
  center:new google.maps.LatLng(lat,lon),
  zoom:10,
};
var map = new google.maps.Map(document.getElementById("googleMap"),mapProp);
}{% endcomment %}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB3ZbQXl3kDtdlyFbhvJarw2-mXoFbh-2o&libraries=places&callback=myMap"></script>
</body>
</html>

{#function initialize() {#}
{#  var pyrmont = new google.maps.LatLng(-33.8665433,151.1956316);#}
{##}
{#  map = new google.maps.Map(document.getElementById('map'), {#}
{#      center: pyrmont,#}
{#      zoom: 15#}
{#    });#}
{##}
{#  var request = {#}
{#    location: pyrmont,#}
{#    radius: '500',#}
{#    type: ['restaurant']#}
{#  };#}
{##}
{#  service = new google.maps.places.PlacesService(map);#}
{#  service.nearbySearch(request, callback);#}
{#}#}
{##}
{#function callback(results, status) {#}
{#  if (status == google.maps.places.PlacesServiceStatus.OK) {#}
{#    for (var i = 0; i < results.length; i++) {#}
{#      createMarker(results[i]);#}
{#    }#}
{#  }#}
{#}#}